<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI HR Recruiter - Bulk Hiring Automation</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .btn { 
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary { 
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        .btn-secondary:hover { 
            background: #f7f7ff;
            transform: translateY(-1px);
        }
        .card { 
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            padding: 40px;
            backdrop-filter: blur(10px);
        }
        .input { 
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: #f9fafb;
        }
        .input:focus { 
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }
        .tab { 
            padding: 14px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 12px 12px 0 0;
            font-weight: 500;
        }
        .tab:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        .tab.active { 
            background: white;
            color: #667eea;
            font-weight: 600;
            border-bottom: 3px solid #667eea;
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // ============= CONFIGURATION =============
        const API_URL = 'http://127.0.0.1:5000'; // Change to Railway URL after deployment
        const DEMO_MODE = true; // Set to false when backend is deployed
        
        // ============= STATE MANAGEMENT =============
        let state = {
            user: null,
            currentTab: 'upload',
            candidates: JSON.parse(localStorage.getItem('candidates') || '[]'),
            messages: JSON.parse(localStorage.getItem('messages') || '[]'),
            jobSettings: JSON.parse(localStorage.getItem('jobSettings') || '{"title":"Software Engineer","company":"Tech Corp","location":"Remote"}'),
            loading: false,
            showCreateAccount: false,
            showForgotPassword: false
        };

        // Demo users storage
        const demoUsers = JSON.parse(localStorage.getItem('demoUsers') || '{"admin":"admin123"}');

        // ============= API FUNCTIONS =============
        async function apiCall(endpoint, options = {}) {
            if (DEMO_MODE) {
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 300));
                return { success: true };
            }
            
            try {
                const response = await fetch(`${API_URL}${endpoint}`, {
                    ...options,
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return { success: false, error: error.message };
            }
        }

        async function login(username, password) {
            if (DEMO_MODE) {
                if (demoUsers[username] === password) {
                    state.user = { username, email: `${username}@demo.com` };
                    localStorage.setItem('currentUser', username);
                    render();
                    return { success: true, user: state.user };
                } else {
                    return { success: false, error: 'Invalid credentials' };
                }
            }
            
            const result = await apiCall('/api/login', {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });
            if (result.success) {
                state.user = result.user;
                render();
            }
            return result;
        }

        async function createAccount(username, password, email) {
            if (DEMO_MODE) {
                if (demoUsers[username]) {
                    return { success: false, error: 'Username already exists' };
                }
                demoUsers[username] = password;
                localStorage.setItem('demoUsers', JSON.stringify(demoUsers));
                return { success: true, message: 'Account created successfully!' };
            }
            return { success: false, error: 'Backend required for account creation' };
        }

        async function resetPassword(email) {
            if (DEMO_MODE) {
                return { success: true, message: 'Password reset link sent to ' + email };
            }
            return { success: false, error: 'Backend required for password reset' };
        }

        async function logout() {
            await apiCall('/api/logout', { method: 'POST' });
            state.user = null;
            render();
        }

        async function uploadResume(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await fetch(`${API_URL}/api/upload-resume`, {
                method: 'POST',
                credentials: 'include',
                body: formData
            });
            return await response.json();
        }

        async function saveCandidate(candidate) {
            if (DEMO_MODE) {
                candidate.id = Date.now();
                candidate.code = 'CND' + Math.random().toString(36).substr(2, 6).toUpperCase();
                state.candidates.push(candidate);
                localStorage.setItem('candidates', JSON.stringify(state.candidates));
                return { success: true };
            }
            return await apiCall('/api/save-candidate', {
                method: 'POST',
                body: JSON.stringify({ candidate })
            });
        }

        async function fetchCandidates() {
            if (DEMO_MODE) {
                state.candidates = JSON.parse(localStorage.getItem('candidates') || '[]');
                render();
                return;
            }
            const result = await apiCall('/api/candidates');
            if (result.success) {
                state.candidates = result.candidates;
                render();
            }
        }

        async function sendMessage(data) {
            if (DEMO_MODE) {
                const message = {
                    id: Date.now(),
                    ...data,
                    timestamp: new Date().toISOString(),
                    status: 'sent (demo)'
                };
                state.messages.push(message);
                localStorage.setItem('messages', JSON.stringify(state.messages));
                return { success: true };
            }
            return await apiCall('/api/send-message', {
                method: 'POST',
                body: JSON.stringify(data)
            });
        }

        async function fetchMessages() {
            if (DEMO_MODE) {
                state.messages = JSON.parse(localStorage.getItem('messages') || '[]');
                render();
                return;
            }
            const result = await apiCall('/api/message-log');
            if (result.success) {
                state.messages = result.messages;
                render();
            }
        }

        // ============= UI COMPONENTS =============
        
        function LoginScreen() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="card max-w-md w-full">
                        <div class="text-center mb-8">
                            <div class="inline-block p-4 bg-gradient-to-br from-purple-100 to-blue-100 rounded-2xl mb-4">
                                <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" class="text-purple-600"></path>
                                </svg>
                            </div>
                            <h1 class="text-4xl font-bold gradient-text mb-3">AI HR Recruiter</h1>
                            <p class="text-gray-500 text-lg">Automate bulk hiring with AI</p>
                        </div>
                        
                        ${state.showCreateAccount ? `
                            <form onsubmit="handleCreateAccount(event)" class="space-y-5">
                                <h2 class="text-2xl font-bold gradient-text mb-6">Create Account</h2>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                                    <input type="text" id="new-username" class="input" placeholder="Choose a username" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                                    <input type="email" id="new-email" class="input" placeholder="your@email.com" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                                    <input type="password" id="new-password" class="input" placeholder="Create a strong password" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-full mt-6">
                                    <i data-lucide="user-plus" class="w-4 h-4 inline mr-2"></i>
                                    Create Account
                                </button>
                                <button type="button" onclick="state.showCreateAccount = false; render()" class="btn btn-secondary w-full">
                                    <i data-lucide="arrow-left" class="w-4 h-4 inline mr-2"></i>
                                    Back to Login
                                </button>
                            </form>
                        ` : state.showForgotPassword ? `
                            <form onsubmit="handleForgotPassword(event)" class="space-y-5">
                                <h2 class="text-2xl font-bold gradient-text mb-6">Reset Password</h2>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email Address</label>
                                    <input type="email" id="reset-email" class="input" placeholder="your@email.com" required>
                                </div>
                                <p class="text-sm text-gray-500">We'll send you a link to reset your password</p>
                                <button type="submit" class="btn btn-primary w-full mt-6">
                                    <i data-lucide="mail" class="w-4 h-4 inline mr-2"></i>
                                    Send Reset Link
                                </button>
                                <button type="button" onclick="state.showForgotPassword = false; render()" class="btn btn-secondary w-full">
                                    <i data-lucide="arrow-left" class="w-4 h-4 inline mr-2"></i>
                                    Back to Login
                                </button>
                            </form>
                        ` : `
                            <form onsubmit="handleLogin(event)" class="space-y-5">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                                    <input type="text" id="username" class="input" placeholder="Enter your username" required>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                                    <div class="relative">
                                        <input type="password" id="password" class="input pr-12" placeholder="Enter your password" required>
                                        <button type="button" onclick="togglePassword()" class="absolute right-4 top-4 text-gray-400 hover:text-gray-600">
                                            <i data-lucide="eye" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary w-full mt-6">
                                    <i data-lucide="log-in" class="w-5 h-5 inline mr-2"></i>
                                    Sign In
                                </button>
                            </form>
                            
                            <div class="mt-6 flex justify-between items-center text-sm">
                                <button onclick="state.showCreateAccount = true; render()" class="font-semibold text-purple-600 hover:text-purple-700 transition">
                                    <i data-lucide="user-plus" class="w-4 h-4 inline mr-1"></i>
                                    Create Account
                                </button>
                                <button onclick="state.showForgotPassword = true; render()" class="font-semibold text-purple-600 hover:text-purple-700 transition">
                                    Forgot Password?
                                </button>
                            </div>
                            
                            <div class="mt-6 p-4 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl border border-purple-100">
                                <p class="text-sm text-gray-600 text-center">
                                    <span class="font-semibold text-purple-700">Demo Login:</span> 
                                    <span class="font-mono bg-white px-2 py-1 rounded">admin</span> / 
                                    <span class="font-mono bg-white px-2 py-1 rounded">admin123</span>
                                </p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function Header() {
            return `
                <header class="bg-white shadow-lg border-b border-gray-100">
                    <div class="max-w-7xl mx-auto px-6 py-5 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <div class="p-2 bg-gradient-to-br from-purple-100 to-blue-100 rounded-xl">
                                <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <h1 class="text-2xl font-bold gradient-text">AI HR Recruiter</h1>
                                <p class="text-sm text-gray-500">Bulk Hiring Automation</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="px-4 py-2 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl border border-purple-100">
                                <span class="text-sm font-semibold text-purple-700">
                                    <i data-lucide="user" class="w-4 h-4 inline mr-1"></i>
                                    ${state.user?.username || 'User'}
                                </span>
                            </div>
                            <button onclick="logout()" class="btn btn-secondary">
                                <i data-lucide="log-out" class="w-4 h-4 inline mr-2"></i>
                                Logout
                            </button>
                        </div>
                    </div>
                </header>
            `;
        }

        function Tabs() {
            const tabs = [
                { id: 'upload', label: 'Upload Resume', icon: 'upload' },
                { id: 'candidates', label: 'Candidates', icon: 'users' },
                { id: 'messages', label: 'Messages', icon: 'mail' },
                { id: 'settings', label: 'Job Settings', icon: 'settings' }
            ];
            
            return `
                <div class="bg-white border-b">
                    <div class="max-w-7xl mx-auto px-4">
                        <div class="flex gap-2">
                            ${tabs.map(tab => `
                                <button onclick="switchTab('${tab.id}')" class="tab ${state.currentTab === tab.id ? 'active' : ''}">
                                    <i data-lucide="${tab.icon}" class="w-4 h-4 inline mr-2"></i>
                                    ${tab.label}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function UploadTab() {
            return `
                <div class="max-w-4xl mx-auto p-6">
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">üìÑ Upload Resume</h2>
                        
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                            <input type="file" id="resumeFile" accept=".png,.jpg,.jpeg,.pdf" class="hidden" onchange="handleFileUpload(event)">
                            <label for="resumeFile" class="cursor-pointer">
                                <i data-lucide="upload-cloud" class="w-16 h-16 mx-auto text-gray-400 mb-4"></i>
                                <p class="text-lg font-medium text-gray-700">Click to upload or drag and drop</p>
                                <p class="text-sm text-gray-500 mt-2">PNG, JPG, JPEG or PDF (Max 10MB)</p>
                            </label>
                        </div>
                        
                        <div id="candidateForm" class="hidden mt-6 space-y-4">
                            <h3 class="font-bold text-lg">Extracted Candidate Details</h3>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Name</label>
                                    <input type="text" id="name" class="input" placeholder="Optional">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Email *</label>
                                    <input type="email" id="email" class="input" placeholder="Required" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Phone *</label>
                                    <input type="tel" id="phone" class="input" placeholder="Required" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Location *</label>
                                    <input type="text" id="location" class="input" placeholder="Required" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Date of Birth</label>
                                    <input type="date" id="dob" class="input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Skills</label>
                                    <input type="text" id="skills" class="input" placeholder="Optional">
                                </div>
                            </div>
                            
                            <button onclick="handleSaveCandidate()" class="btn btn-primary">
                                <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                                Save Candidate
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function CandidatesTab() {
            return `
                <div class="max-w-7xl mx-auto p-6">
                    <div class="card">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">üë• Candidate Management</h2>
                            <div class="flex gap-2">
                                <button onclick="sendToAll()" class="btn btn-primary text-sm">
                                    <i data-lucide="mail" class="w-4 h-4 inline mr-2"></i>
                                    Send to All (${state.candidates.length})
                                </button>
                                <button onclick="fetchCandidates()" class="btn btn-secondary text-sm">
                                    <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>
                        
                        ${state.candidates.length === 0 ? `
                            <div class="text-center py-12 text-gray-500">
                                <i data-lucide="users" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                                <p>No candidates found. Upload a resume to get started.</p>
                            </div>
                        ` : `
                            <div class="space-y-4">
                                ${state.candidates.map(candidate => `
                                    <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <h3 class="font-bold text-lg">${candidate.name || 'Unknown'}</h3>
                                                <div class="grid grid-cols-2 gap-2 mt-2 text-sm text-gray-600">
                                                    <p><strong>Email:</strong> ${candidate.email}</p>
                                                    <p><strong>Phone:</strong> ${candidate.phone}</p>
                                                    <p><strong>Location:</strong> ${candidate.location}</p>
                                                    <p><strong>Code:</strong> ${candidate.code}</p>
                                                    <p><strong>Status:</strong> <span class="px-2 py-1 rounded text-xs ${
                                                        candidate.status === 'New' ? 'bg-gray-100' :
                                                        candidate.status === 'Contacted' ? 'bg-blue-100' :
                                                        candidate.status === 'Interview Scheduled' ? 'bg-green-100' :
                                                        'bg-red-100'
                                                    }">${candidate.status}</span></p>
                                                </div>
                                            </div>
                                            <button onclick="sendMessageToCandidate(${candidate.id}, '${candidate.email}', '${candidate.phone}', '${candidate.name}', '${candidate.code}', '${candidate.location}')" class="btn btn-primary text-sm">
                                                <i data-lucide="mail" class="w-4 h-4 inline mr-1"></i>
                                                Send Message
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function MessagesTab() {
            return `
                <div class="max-w-7xl mx-auto p-6">
                    <div class="card">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">üìß Messages Log</h2>
                            <button onclick="fetchMessages()" class="btn btn-secondary text-sm">
                                <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></i>
                                Refresh
                            </button>
                        </div>
                        
                        ${state.messages.length === 0 ? `
                            <div class="text-center py-12 text-gray-500">
                                <i data-lucide="mail" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                                <p>No messages sent yet.</p>
                            </div>
                        ` : `
                            <div class="space-y-4">
                                ${state.messages.map(msg => `
                                    <div class="border rounded-lg p-4">
                                        <div class="flex items-start gap-3">
                                            <div class="p-2 rounded-lg ${msg.type === 'email' ? 'bg-blue-100' : 'bg-green-100'}">
                                                <i data-lucide="${msg.type === 'email' ? 'mail' : 'message-square'}" class="w-5 h-5"></i>
                                            </div>
                                            <div class="flex-1">
                                                <div class="flex justify-between items-start mb-2">
                                                    <div>
                                                        <span class="font-medium">${msg.type.toUpperCase()}</span>
                                                        <span class="text-xs text-gray-500 ml-2">${msg.timestamp}</span>
                                                    </div>
                                                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">Simulated</span>
                                                </div>
                                                <p class="text-sm text-gray-600"><strong>To:</strong> ${msg.to}</p>
                                                ${msg.subject ? `<p class="text-sm text-gray-600"><strong>Subject:</strong> ${msg.subject}</p>` : ''}
                                                <p class="text-sm text-gray-700 mt-2 whitespace-pre-wrap">${msg.message}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function SettingsTab() {
            return `
                <div class="max-w-4xl mx-auto p-6">
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">‚öôÔ∏è Job Settings</h2>
                        <p class="text-gray-600 mb-6">Configure job details for candidate communication</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Job Title</label>
                                <input type="text" id="jobTitle" class="input" placeholder="e.g., Software Engineer">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Company Name</label>
                                <input type="text" id="companyName" class="input" placeholder="e.g., Tech Corp">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Location</label>
                                <input type="text" id="jobLocation" class="input" placeholder="e.g., Mumbai, India">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Salary Range</label>
                                <input type="text" id="salaryRange" class="input" placeholder="e.g., ‚Çπ8-12 LPA">
                            </div>
                            
                            <button onclick="saveJobSettings()" class="btn btn-primary">
                                <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                                Save Settings
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============= EVENT HANDLERS =============
        
        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const result = await login(username, password);
            if (!result.success) {
                alert('Login failed: ' + (result.error || 'Invalid credentials'));
            }
        }

        async function handleCreateAccount(event) {
            event.preventDefault();
            const username = document.getElementById('new-username').value;
            const email = document.getElementById('new-email').value;
            const password = document.getElementById('new-password').value;
            
            const result = await createAccount(username, password, email);
            if (result.success) {
                alert('‚úÖ Account created successfully! You can now login.');
                state.showCreateAccount = false;
                render();
            } else {
                alert('Error: ' + result.error);
            }
        }

        async function handleForgotPassword(event) {
            event.preventDefault();
            const email = document.getElementById('reset-email').value;
            
            const result = await resetPassword(email);
            if (result.success) {
                alert('‚úÖ ' + result.message);
                state.showForgotPassword = false;
                render();
            } else {
                alert('Error: ' + result.error);
            }
        }

        function togglePassword() {
            const input = document.getElementById('password');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const result = await uploadResume(file);
            if (result.success) {
                const candidate = result.candidate;
                document.getElementById('name').value = candidate.name || '';
                document.getElementById('email').value = candidate.email || '';
                document.getElementById('phone').value = candidate.phone || '';
                document.getElementById('location').value = candidate.location || '';
                document.getElementById('dob').value = candidate.dob || '';
                document.getElementById('skills').value = candidate.skills || '';
                
                document.getElementById('candidateForm').classList.remove('hidden');
            } else {
                alert('Upload failed: ' + result.error);
            }
        }

        async function handleSaveCandidate() {
            const candidate = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                location: document.getElementById('location').value,
                dob: document.getElementById('dob').value,
                skills: document.getElementById('skills').value,
                date: new Date().toISOString().split('T')[0]
            };
            
            const result = await saveCandidate(candidate);
            if (result.success) {
                alert('‚úÖ Candidate saved successfully!');
                document.getElementById('candidateForm').classList.add('hidden');
                document.getElementById('resumeFile').value = '';
                switchTab('candidates');
                fetchCandidates();
            } else {
                alert('Error: ' + result.error);
            }
        }

        async function sendMessageToCandidate(id, email, phone, name, code, location) {
            const message = `Hi ${name || 'there'},

We found your profile suitable for a position at our company.

Interview Details:
Date: [To be scheduled]
Time: [To be scheduled]
Location: ${location}

Your Candidate Code: ${code}

Please confirm your availability.

Best regards,
HR Team`;

            const result = await sendMessage({
                candidate_id: id,
                email: email,
                phone: phone,
                subject: 'Job Opportunity',
                message: message,
                send_email: true,
                send_sms: true
            });
            
            if (result.success) {
                alert('‚úÖ Message sent successfully! (Simulated in demo mode)');
                fetchMessages();
            } else {
                alert('Error: ' + result.error);
            }
        }

        async function sendToAll() {
            if (!confirm(`Send message to all ${state.candidates.length} candidate(s)?`)) return;
            
            let success = 0;
            for (const candidate of state.candidates) {
                const result = await sendMessageToCandidate(
                    candidate.id, candidate.email, candidate.phone,
                    candidate.name, candidate.code, candidate.location
                );
                if (result) success++;
            }
            
            alert(`‚úÖ Bulk messaging complete!\n\nSuccess: ${success}\n\n(Demo Mode - Messages simulated)`);
            fetchCandidates();
        }

        function switchTab(tab) {
            state.currentTab = tab;
            render();
            
            if (tab === 'candidates') fetchCandidates();
            if (tab === 'messages') fetchMessages();
        }

        // ============= RENDER FUNCTION =============
        
        function render() {
            const app = document.getElementById('app');
            
            if (!state.user) {
                app.innerHTML = LoginScreen();
                document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            } else {
                let content = '';
                if (state.currentTab === 'upload') content = UploadTab();
                else if (state.currentTab === 'candidates') content = CandidatesTab();
                else if (state.currentTab === 'messages') content = MessagesTab();
                else if (state.currentTab === 'settings') content = SettingsTab();
                
                document.body.style.background = '#f3f4f6';
                app.innerHTML = Header() + Tabs() + `<div class="bg-gray-100 min-h-screen">${content}</div>`;
            }
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // ============= INITIALIZE APP =============
        
        window.onload = () => {
            render();
        };
    </script>
</body>
</html>
